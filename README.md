<h1 align="center">Kpm: KCL Package Manager</h1>

<p align="center">
<a href="./README.md">English</a> | <a href="./README-zh.md">简体中文</a>
</p>
<p align="center">
<a href="#introduction">Introduction</a> | <a href="#installation">Installation</a> | <a href="#quick-start">Quick start</a> 
</p>

<p align="center">
<img src="https://coveralls.io/repos/github/KusionStack/kpm/badge.svg">
<img src="https://img.shields.io/badge/license-Apache--2.0-green">
<img src="https://img.shields.io/badge/PRs-welcome-brightgreen">
</p>

## Introduction

`kpm` is the KCL package manager. `kpm` downloads your KCL package's dependencies, compiles your KCL packages, makes packages, and uploads them to the kcl package registry.

## Installation

### Install KCLVM

`kpm` will call [KCLVM](https://github.com/KusionStack/KCLVM) to compile the kcl program. Before using `kpm`, you need to ensure that KCLVM is installed successfully.

[For more information about how to install KCLVM.](https://kcl-lang.io/docs/user_docs/getting-started/install)

Use the following command to ensure that you install KCLVM successfully.

```shell
kclvm_cli --help
```

If you get the following output, you have successfully installed KCLVM and you can proceed to the following steps.

```shell
kclvm_cli

USAGE:
    kclvm_cli [SUBCOMMAND]

OPTIONS:
    -h, --help    Print help information

SUBCOMMANDS:
    fmt
    help       Print this message or the help of the given subcommand(s)
    lint
    run
    server
    version
    vet
```

### Install `kpm`

You can get `kpm` from the github release and set the `kpm` binary to the environment variable PATH.

```shell
# KPM_INSTALLATION_PATH is the path of the `kpm` binary.
export PATH=$KPM_INSTALLATION_PATH:$PATH  
```

Use the following command to ensure that you install `kpm` successfully.

```shell
kpm --help
```

If you get the following output, you have successfully installed `kpm` and you can proceed to the following steps.

```shell
NAME:
   kpm - kpm is a kcl package manager

USAGE:
   kpm  <command> [arguments]...

VERSION:
   v0.0.1

COMMANDS:
   init     initialize new module in current directory
   add      add new dependancy
   pkg      package a kcl package into tar
   run      compile kcl package.
   help, h  Shows a list of commands or help for one command

GLOBAL OPTIONS:
   --help, -h     show help
   --version, -v  print the version
```

### Set environment variables

You need to set an environment variable `KPM_HOME` to hold the KCL packages downloaded by `kpm`.

```shell
# The directory to save the packages downloaded by Kpm. 
export KPM_HOME="/user/xxx/xxx/path" 
```

To ensure that KCLVM can find the packages downloaded by `kpm`, you need to set the environment variables `$KCLVM_VENDOR_HOME` and point it to `$KPM_HOME` for KCLVM after downloading KCLVM.

```shell
export KCLVM_VENDOR_HOME=$KPM_HOME
```

## Quick Start

### Init an empty kcl package

Create a new kcl package named `mykcl`.

```shell
kpm init mykcl
```

`kpm` will create two kcl package configuration files: `kcl.mod` and `kcl.mod.lock` in the directory where you executed the command.

```shell
- my_kcl
   |- kcl.mod
   |- kcl.mod.lock
   |- # You can write your kcl program directly in this directory.
```

`kcl.mod.lock` is the file generated by `kpm` to fix the dependency version. Do not modify this file manually.

`kpm` initializes `kcl.mod` for an empty project as shown below:

```shell
[package]
name = "my_kcl"
edition = "0.0.1"
version = "0.0.1"
```

### Add a dependency from Git Registry

If you need to use the KCL model in [Konfig](https://github.com/awesome-kusion/konfig.git) to write the kcl program.

```shell
kpm add -git https://github.com/awesome-kusion/konfig.git -tag v0.0.1
```

In this directory `$KPM_HOME`, you will be able to see the kcl package you downloaded.

```shell
- $KPM_HOME
      | - konfig_v0.0.1
```

You can also see that `kpm` adds the dependency you just added to kcl.mod.

```shell
[package]
name = "my_kcl"
edition = "0.0.1"
version = "0.0.1"

[dependencies]
# 'konfig' is the package name
# If you want to use the contents of this package, 
# you need to write the import statment with the package name 'konfig' as the prefix.
konfig = { git = "https://github.com/awesome-kusion/konfig.git", tag = "v0.0.1" }
```

### Write a kcl program that uses the content in `konfig`

Create the `main.k` file in the current package.

```shell
- my_kcl
   |- kcl.mod
   |- kcl.mod.lock
   |- main.k # Your KCL program.
```

And write the following into the `main.k` file.

```kcl
import konfig.base.examples.native.nginx_deployment as nd

demo = nd.demo
```

### Use the `kpm` compile the kcl package

You can use `kpm` to compile the `main.k` file you just wrote.

```shell
kpm run --input /my_kcl/main.k
```

If you get the following output, congratulations !, you have successfully compiled your kcl package with `kpm`.

```shell
demo:
  apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: nginx-deployment
  spec:
    replicas: 3
    selector:
      matchLabels:
        app: nginx
    template:
      metadata:
        labels:
          app: nginx
      spec:
        containers:
          - image: "nginx:1.14.2"
            name: nginx
            ports:
              - containerPort: 80
```

### Package your current kcl package with its dependencies

You can use the command `kpm pkg` to package your current kcl package with its dependencies.

```shell
kpm pkg --target /my_kcl/my_kcl.tar
```

After this command is executed, a tar package will be packaged in the `/my_kcl/my_kcl.tar` directory. And all the dependencies for `my_kcl` will be stored in the `vendor` subdirectory.

```shell
- my_kcl
   |- kcl.mod
   |- kcl.mod.lock
   |- main.k
   |- my_kcl.tar # The file (*.tar) packaged by kpm.
   |- vendor # All the dependencies for `my_kcl` will be stored in the `vendor` 
        |- konfig_v0.0.1
```

